<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sign in to your Nove account</title>
        <link rel="stylesheet" href="/css/main.css" />
        <link rel="stylesheet" href="/css/login.css" />
    </head>
    <body>
        <main>
            <section class="login">
                <img src="/data/logo.png" width="48" height="48" alt="Nove logo" />
                <h1>Sign in</h1>
                <p>To continue please sign in to your Nove account</p>
                <section id="error"></section>
                <form id="form">
                    <input type="text" name="username" placeholder="Username" /><br />
                    <input type="password" name="password" placeholder="Password" /><br />
                    <button type="submit">Login</button><br />
                </form>
            </section>
        </main>

        <script>
            document.getElementById('form').addEventListener('submit', submit);

            function submit(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                const username = data.get('username');
                const password = data.get('password');

                fetch('/v1/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username,
                        password,
                    }),
                })
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.body.error) {
                            document.getElementById('error').innerHTML =
                                '<header id="error">' + data.body.error.message.charAt(0).toUpperCase() + data.body.error.message.slice(1) + '</header>';
                        } else {
                            localStorage.setItem('token', data.body.data.token);

                            const redirect = new URLSearchParams(window.location.search).get('redirectBack');
                            if (!redirect) window.location.href = 'https://nove.team/account';
                            else if (redirect == '__CLOSE__') window.close();
                            else window.location.href = redirect;
                        }
                    });
            }
        </script>
    </body>
</html>
